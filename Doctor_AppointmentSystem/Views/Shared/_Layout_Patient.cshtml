@using Doctor_AppointmentSystem.Models
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    Layout = null;

    var currentUser = await UserManager.GetUserAsync(User);

    var fullName = ((currentUser?.FirstName ?? "") + " " + (currentUser?.LastName ?? ""))
                   .Trim();

    var userName = !string.IsNullOrWhiteSpace(fullName)
        ? fullName
        : (currentUser?.UserName ?? "Patient");

    var firstLetter = string.IsNullOrWhiteSpace(userName)
        ? "P"
        : userName.Trim()[0].ToString().ToUpper();

    var profileImagePath = currentUser?.ProfileImagePath;

    var pageTitle = ViewData["Title"] as string ?? "Patient Dashboard";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>@(ViewData["Title"] ?? "Patient Dashboard | Doctor Appointment System")</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <!-- shared admin layout styles (sidebar, cards, grids etc.) -->
    <link rel="stylesheet" href="~/css/admin-dashboard.css" asp-append-version="true" />

    <!-- patient-specific dashboard content styles -->
    <link rel="stylesheet" href="~/css/patient-dashboard.css" asp-append-version="true" />
</head>
<body>
    <div class="admin-layout">
        <!-- SIDEBAR (same structure as Doctor/Admin) -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                @if (!string.IsNullOrEmpty(profileImagePath))
                {
                    <img src="@Url.Content(profileImagePath)" alt="Profile" class="admin-avatar-img" />
                }
                else
                {
                    <div class="admin-avatar">@firstLetter</div>
                }

                <div class="sidebar-role">PATIENT</div>
                <div class="sidebar-username">@userName</div>
                <div class="sidebar-subtitle">Doctor Appointment System</div>
            </div>

            <nav class="sidebar-nav">
                <!-- DASHBOARD -->
                <a asp-controller="PatientDashboard"
                   asp-action="Index"
                   class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString() == "PatientDashboard" ? "active" : "")">
                    <div class="nav-link-icon">📊</div>
                    <span>Dashboard</span>
                </a>

                <!-- BOOK APPOINTMENT -->
                <a asp-controller="DoctorAppointments"
                   asp-action="FindDoctor"
                   class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString() == "DoctorAppointments" ? "active" : "")">
                    <div class="nav-link-icon">📅</div>
                    <span>Book Appointment</span>
                </a>

                <!-- MY APPOINTMENTS -->
                <a asp-controller="PatientAppointments"
                   asp-action="Index"
                   class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString() == "PatientAppointments" ? "active" : "")">
                    <div class="nav-link-icon">📆</div>
                    <span>My Appointments</span>
                </a>

                <!-- NOTIFICATIONS -->
                <a asp-controller="PatientNotifications"
                   asp-action="Index"
                   class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString() == "PatientNotifications" ? "active" : "")">
                    <div class="nav-link-icon">🔔</div>
                    <span>Notifications</span>
                </a>

                <!-- PROFILE -->
                <a asp-controller="PatientProfile"
                   asp-action="Index"
                   class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString() == "PatientProfile" ? "active" : "")">
                    <div class="nav-link-icon">👤</div>
                    <span>My Profile</span>
                </a>

                <!-- SETTINGS DROPDOWN -->
                <div class="nav-dropdown">
                    <div class="nav-dropdown-toggle" data-dropdown>
                        <div class="nav-dropdown-toggle-main">
                            <div class="nav-link-icon">⚙️</div>
                            <span>Settings</span>
                        </div>
                        <span class="nav-dropdown-arrow">▾</span>
                    </div>

                    <div class="nav-submenu">
                        <a asp-controller="Settings"
                           asp-action="Index"
                           class="nav-link nav-link--sub">
                            General Settings
                        </a>

                        <a asp-controller="Settings"
                           asp-action="ChangePassword"
                           class="nav-link nav-link--sub">
                            Change Password
                        </a>
                    </div>
                </div>

                <!-- LOGOUT -->
                @if (User?.Identity?.IsAuthenticated ?? false)
                {
                    <form asp-area="Identity"
                          asp-page="/Account/Logout"
                          asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })"
                          method="post">
                        <button type="submit" class="nav-link nav-link-button">
                            <div class="nav-link-icon">↩</div>
                            <span>Logout</span>
                        </button>
                    </form>
                }
            </nav>
        </aside>

        <!-- MAIN (identical structure to Admin/Doctor) -->
        <main class="main">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="menu-toggle" id="menuToggle">☰</button>
                    <div>
                        <div class="topbar-title">@pageTitle</div>
                    </div>
                </div>
                <div class="topbar-right">
                    <div class="topbar-date" id="currentDate"></div>
                </div>
            </header>

            <section class="dashboard-content">
                @RenderBody()
            </section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- shared JS used by admin/doctor: handles currentDate & sidebar toggle -->
    <script src="~/js/admin-dashboard.js" asp-append-version="true"></script>

    @RenderSection("Scripts", required: false)
</body>
</html>
